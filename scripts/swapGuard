
#!/bin/bash


totalMem=0
usedMem=0
freeMem=0
usageFreq=0

touch ~/.swapGuardActive

function tryToFree()
{
    
    totalMem=`free | sed -n 2p | awk '{print $2}'`
    usedMem=`free | sed -n 2p | awk '{print $3}'`
    freeMem=`free | sed -n 2p | awk '{print $3}'`
    usageFreq=$(( ( (usedMem)*100 )/totalMem ))
    
    if [[ $usageFreq -lt 50 ]]; then
        #echo "$usageFreq Freeing swap space"
        sudo swapoff /var/swap
        sleep 1
        sudo swapon /var/swap
        sleep 10
    else
        #echo "$usageFreq Trying to free"
        sleep 1
        
        if [[ -f ~/.swapGuardActive ]]; then tryToFree; fi
    fi

}

function main()
{
    swapUsage=`free | sed -n 3p | awk '{print $3}'`
    if [[ $swapUsage -gt 0 ]]; then
        tryToFree
    fi
    sleep 1
    #echo "$$"
    #echo "$usageFreq Swap is fine"

    if [[ -f ~/.swapGuardActive ]]; then main; fi
}

echo "SwapGuard On"
main
echo "SwapGuard Off"
